!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var s=e();for(var i in s)("object"==typeof exports?exports:t)[i]=s[i]}}(window,(function(){return function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=1)}([function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return CanvasContext}));class CanvasContext{constructor(t,e){this.el=e,this.oct=t;const s=this;return new Proxy(t,{get(t,e){if(s[e])return s[e];{let s=t[e];return s instanceof Function?s.bind(t):s}},set:(t,e,i)=>(s[e]?s[e]=i:t[e]=i,!0)})}isPercent(t){return"string"==typeof t&&"%"===t.substr(t.length-1)}rounded(t){let e=.5+t|0;return e=~~(.5+t),e=.5+t<<0}transPercent(num,rate){if("string"==typeof num){let percentRate="*"+rate,vwRate="*"+this.el.layer.style.w/100,vhRate="*"+this.el.layer.style.h/100;return num=num.replace("%",percentRate),num=num.replace("vw",vwRate),num=num.replace("vh",vhRate),eval(num)}return num}transReferW(t){let e=this.el.w/100;return this.transPercent(t,e)}transReferH(t){let e=this.el.h/100;return this.transPercent(t,e)}transData(t,e,s,i){return[this.transReferW(t),this.transReferH(e),this.transReferW(s),this.transReferH(i)]}rect({x:t,y:e,w:s,h:i,border:r,color:n="black",backgroundColor:h}){[t,e,s,i]=this.transData(t,e,s,i),this.oct.save(),this.oct.rect(t,e,s,i),r&&(r=this.transReferW(r),this.oct.strokeStyle=n,this.oct.lineWidth=r),h&&(this.oct.fillStyle=h),this.oct.stroke(),this.oct.fill(),this.oct.restore()}poly(t,e,s,i="black"){this.oct.strokeStyle=i,this.oct.lineWidth=s,this.oct.beginPath();let r=t[0],n=e[0];this.oct.moveTo(r,n);for(let s=1;s<t.length;s++)if(s<e.length){let i=t[s],r=e[s];this.oct.lineTo(i,r),this.oct.moveTo(i,r)}this.oct.lineTo(r,n),this.oct.moveTo(r,n),this.oct.closePath(),this.oct.stroke()}}},function(t,e,s){"use strict";s.r(e);const i=!1;class r{constructor({style:t={},el:e=[]},s,i){this.style=t,this.brush=s,this.index=i,this.eventSet=new Set,this.mouseInSet=new Set,this.mouseOutSet=new Set,this.updateMap=new Set,this.createCanvas(),this.el=this.toArray(e),this.el.forEach(t=>{t.bindFromLayer(this)})}createCanvas(){let t,e,s,r;this.canvas=document.createElement("canvas"),t=this.style.hasOwnProperty("w")?this.style.w:this.brush.style.w,e=this.style.hasOwnProperty("h")?this.style.h:this.brush.style.h,s=this.style.hasOwnProperty("x")?this.style.x:0,r=this.style.hasOwnProperty("y")?this.style.y:0,this.canvas.width=t,this.canvas.height=e,this.canvas.style.position="absolute",this.canvas.style.left=s+"px",this.canvas.style.top=r+"px",this.style.backgroundColor&&(this.canvas.style.background=this.style.backgroundColor),this.registEvent(),this.brush.root.appendChild(this.canvas),this.ctx=this.canvas.getContext(i?"bitmaprenderer":"2d",{alpha:!0}),i&&OffscreenCanvas&&(this.worker=new Worker("./src/worker.js"),this.worker.postMessage({type:"init",w:t,h:e}),this.worker.onmessage=t=>{let e=t.data;this.ctx.transferFromImageBitmap(e)})}addElement(t){return t.bind(this),this.el.push(t),t}isCanvasHasAlpha(){if(!0===this.style.alpha)return!0;if(!1===this.style.alpha)return!1;let t=this.style.backgroundColor;return!!t&&!!(t.length>=13&&"rgba"===t.substr(0,4)&&t.substr("1"===t.substr(t.length-2,1)))}get layerVisibility(){return this.brush.checkLayerVisibility(this.index)}render(){return!!this.layerVisibility&&(this.clear(),this.el.forEach(t=>{t.isNew||t.render()}),this.collectChildsCanvas(),!0)}clear(){this.canvas.width=this.canvas.width}collectChildsCanvas(){i&&OffscreenCanvas&&Worker?this.offscreenCollect():this.normalCollect()}normalCollect(){this.el.forEach(t=>{let e=t.canvas,s=t.props.x,i=t.props.y;this.ctx.drawImage(e,s,i)})}offscreenCollect(){this.worker.postMessage({type:"begin"}),this.el.forEach(t=>{let e=t.canvas,s=t.props.x,i=t.props.y;this.worker.postMessage({type:"commit",data:e.transferToImageBitmap(),x:s,y:i})}),this.worker.postMessage({type:"end"})}receiveUpdate(t){this.layerVisibility&&(this.updateMap.add(t),this.handleUpdate())}handleUpdate(){this.updater&&window.cancelAnimationFrame(this.updater),this.updater=window.requestAnimationFrame(()=>{this.signRenderChain(),this.render(),this.defaultAfterRender()})}signRenderChain(){for(let t of this.updateMap.values()){let e=t.renderChain;for(let t of e)t.isNew=!1}}defaultAfterRender(){this.updateMap=new Set}toArray(t){return Array.isArray(t)?t:t instanceof Object&&(t.hasOwnProperty(0)||t.hasOwnProperty("0"))?Array.from(t):[t]}eventDispatch(t,e,s){let i=this.toArray(this.el);for(let r=i.length-1;r>=0;r--){if(i[r].eventDispatch(t,e,s))return}}getMousePosition(t){let e,s;return t.pageX||t.pageY?(e=t.pageX,s=t.pageY):(e=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),e-=this.canvas.offsetLeft,s-=this.canvas.offsetTop,[e|=0,s|=0]}reportInEvent(t){this.mouseInSet.add(t)}reportOutEvent(t){this.mouseOutSet.add(t)}ansysMouseoverEventSet(){for(let t of this.mouseInSet.values())this.mouseInSetOld.has(t)||t.trigerEventFromSelf("in");for(let t of this.mouseOutSetOld.values())this.mouseOutSet.has(t)||t.trigerEventFromSelf("out")}registEvent(){this.eventSet.has("click")&&this.registClickEvent(),this.eventSet.has("over")&&this.registOverEvent()}registClickEvent(){this.canvas.addEventListener("click",t=>{let[e,s]=this.getMousePosition(t);this.eventDispatch("click",e,s)},!1)}registOverEvent(){this.canvas.addEventListener("mousemove",t=>{this.mouseInSetOld=this.mouseInSet,this.mouseOutSetOld=this.mouseOutSet,this.mouseInSet=new Set,this.mouseOutSet=new Set;let[e,s]=this.getMousePosition(t);this.eventDispatch("over",e,s),this.ansysMouseoverEventSet()},!1)}registEventFromElement(t){this.eventSet.has(t)||(this.eventSet.add(t),"click"===t?this.registClickEvent():"over"===t&&this.registOverEvent())}changeCursor(t){this.canvas.style.cursor=t}}var n=s(0);class h{constructor(t={}){const e=this;this.childElements=[],this.allChildElements=[],this.tempChildStack=[],this.tempChildSet=new Set,this.elMap={},this.isNew=!1,this.renderChain=[this],this.hasInit=!1,this.isAnsysingDependence=!1,this.isCollectingChilds=!1,this.dependence={},this.stateDependence={},this.eventsMap={},this.baseProps={w:100,h:100,x:0,y:0},this.defaultProps={},this.props=new Proxy(t,{get(t,s){let i;return t.hasOwnProperty(s)?i=t[s]:e.defaultProps.hasOwnProperty(s)?i=e.defaultProps[s]:e.baseProps.hasOwnProperty(s)&&(i=e.baseProps[s]),e.isAnsysingDependence&&(e.dependence[s]=i),i},set(t,s,i){return s in["x","y"]?i!==this.props[s]&&e.positionChanged():s in["w","h"]&&e.sizeChanged(),t[s]=i,!0}});const s={};this.el=new Proxy({},{get(t,i){if(!s.hasOwnProperty(i)){let t=e.elMap[i];t.bindFromElement(e);let r=s=>{void 0===s&&(s={});let i=t.renderWithProps(s),r=t.props.x,n=t.props.y;return e.ctx.drawImage(i,r,n),t};s[i]=r}if(e.isCollectingChilds){let t=e.elMap[i];e.tempChildStack.push(t)}return s[i]}}),this.data=new Proxy({},{get(t,s){if(e.state.hasOwnProperty(s)){let t=e.state[s];return e.isAnsysingDependence&&(e.stateDependence[s]=t),t}if(e.props.hasOwnProperty(s))return e.props[s]},set(t,s,i){e.ansysStateChange(s,i),e.state[s]=i}})}initOffscreenCanvas(){let[t,e]=[this.props.w,this.props.w];OffscreenCanvas?this.canvas=new OffscreenCanvas(t,e):(this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e),this.originContext=this.canvas.getContext("2d"),this.initContext()}initContext(){let t=this.canvas.getContext("2d");this.ctx=new n.a(t,this)}bindFromLayer(t){this.father=t,this.layer=t,this.renderChain=[this],this.defaultCreated(),this.created(),this.created=function(){}}bindFromElement(t){this.father=t,this.layer=t.layer,this.renderChain=t.renderChain.slice(),this.renderChain.push(this),this.defaultCreated(),this.created(),this.created=function(){}}toArray(t){return Array.isArray(t)?t:t instanceof Object&&(t.hasOwnProperty(0)||t.hasOwnProperty("0"))?Array.from(t):[t]}addChild(t){let e=this.toArray(t);this.childElements=e.map(t=>e=>{t.bindFromElement(this),void 0===e&&(e={});let s=t.renderWithProps(e),i=t.props.x,r=t.props.y;return that.ctx.drawImage(s,i,r),t})}isChildsOverdue(){for(let t in this.elMap){if(!this.elMap[t].isNew)return!0}return!1}isWorthToUpdate(t){if(!this.hasInit)return!0;for(let e in t)if(this.dependence.hasOwnProperty(e)){if(this.hasChangeProps(t[e],this.dependence[e]))return!0}return!1}hasChangeProps(t,e){const s=function(t,e){if(t===e)return!1;if("object"==typeof t&&"object"==typeof e){for(let i in t){if(!e.hasOwnProperty(i))return!0;if("object"==typeof t[i]){if(s(t[i],e[i]))return!0}else if(t[i]!==e[i])return!0}return!1}return!0};return s(t,e)}renderWithProps(t){return Object.assign(this.props,t),!this.isNew||this.isChildsOverdue()||this.isWorthToUpdate(t)?this.render():this.canvas}setProps(t){Object.assign(this.props,t)}clear(){this.canvas.width=this.canvas.width}ansysStateChange(t,e){}setState(t){this.state||(this.state={}),this.state=Object.assign(this.state,t),this.update()}update(){this.layer.receiveUpdate(this)}render(){return this.defaultBeforePaint(),this.beforePaint(),this.paint(),this.afterPaint(),this.defaultAfterPaint(),this.canvas}defaultCreated(){this.initOffscreenCanvas()}defaultBeforePaint(){this.isAnsysingDependence=!0,this.isCollectingChilds=!0,this.allChildElements=this.toArray(this.childElements).slice(),this.tempChildStack=[],this.tempChildSet=new Set,this.dependence={},this.stateDependence={}}defaultAfterPaint(){this.hasInit||(this.hasInit=!0,this.updated()),this.processChildsElement(),this.isAnsysingDependence=!1,this.isNew=!0}processChildsElement(){if(this.isCollectingChilds){for(;this.tempChildStack.length>0;){let t=this.tempChildStack.pop();this.tempChildSet.has(t)||(this.tempChildSet.add(t),this.allChildElements.unshift(t))}this.tempChildStack=[],this.tempChildSet=new Set,this.isCollectingChilds=!1}}reqFrame(t){t(),this.father.update()}positionChanged(){this.father.update()}sizeChanged(){this.canvas.w=this.w,this.canvas.h=this.h,this.update()}eventDispatchControl(t,e,s,i){let r=i.x<=e&&e<=i.x+i.w,n=i.y<=s&&s<=i.y+i.h;r&&n&&i.eventDispatch(t,e-i.x,s-i.y)}eventDispatch(t,e,s){for(let i=this.allChildElements.length-1;i>=0;i--){let r=this.allChildElements[i];if(this.eventDispatchControl(t,e,s,r))return}return!!this.ctx.isPointInPath(e,s)&&(this.trigerEventFromSelf(t),!0)}trigerEvent(t){if(this.eventsMap.hasOwnProperty(t)){this.eventsMap[t].forEach(t=>{t()})}}trigerEventFromSelf(t){this.trigerEvent(t),this.eventBubbling(t)}trigerEventFromBubbling(t,e){this.trigerEvent(t),this.eventBubbling(t)}eventBubbling(t){this.father instanceof h&&this.father.trigerEventFromBubbling(t,this)}addEvent(t,e){this.eventsMap.hasOwnProperty(t)||(this.eventsMap[t]=[]),this.eventsMap[t].push(e),"in"===t?this.addEvent("over",()=>{this.layer.reportInEvent(this)}):"out"===t&&this.addEvent("over",()=>{this.layer.reportOutEvent(this)}),this.layer.registEventFromElement(t)}changeCursor(t){this.layer.changeCursor(t)}get w(){return this.props.w}get h(){return this.props.h}get x(){return this.props.x}get y(){return this.props.y}get bg(){return this.props.backgroundColor}created(){}beforePaint(){}afterPaint(){}updated(){}}s.d(e,"Brush",(function(){return a})),s.d(e,"BrushElement",(function(){return h}));class a{constructor({w:t,h:e,root:s,state:i={}}){this.style={w:t,h:e},this.root=s,this.subscriberMap={},this.state=new Proxy(i,{get:(t,e)=>t[e],set(t,e,s){t[e]=s,this.dispatch(e,s)}}),this.eventBus={},this.root.style.width=t+"px",this.root.style.height=e+"px",this.layers=[]}createLayer({style:t,el:e}){const s=new r({style:t,el:e},this,this.layers.length);return this.layers.push(s),s}checkLayerVisibility(t){for(let e=this.layers.length-1;e>=0;e--){if(e<=t)return!0;if(!this.layers[e].isCanvasHasAlpha())return!1}return!0}dispatch(t,e){this.subscriberMap.hasOwnProperty(t)&&(Array.isArray(this.subscriberMap[t])||this.subscriberMap[t].forEach(s=>{s(t,e)}))}subscribe(t,e){this.subscriberMap.hasOwnProperty(t)&&(Array.isArray(this.subscriberMap[t])||(this.subscriberMap[t]=[])),this.subscriberMap[t].push(e)}emitEvent(){}listenEvent(){}render(){this.layers.forEach(t=>{t.render()})}}}])}));