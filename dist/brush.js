!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var s=t();for(var r in s)("object"==typeof exports?exports:e)[r]=s[r]}}(window,(function(){return function(e){var t={};function s(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(r,i,function(t){return e[t]}.bind(null,i));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t);class r{constructor({style:e={},el:t=[]},s){this.style=e,this.brush=s,this.updateMap=new Set,this.createCanvas(),this.el=Array.isArray(t)?t:[t],this.el.forEach(e=>{e.bindFromLayer(this)})}createCanvas(){let e,t,s,r;this.canvas=document.createElement("canvas"),e=this.style.hasOwnProperty("w")?this.style.w:this.brush.style.w,t=this.style.hasOwnProperty("h")?this.style.h:this.brush.style.h,s=this.style.hasOwnProperty("x")?this.style.x:0,r=this.style.hasOwnProperty("y")?this.style.y:0,this.canvas.width=e,this.canvas.height=t,this.canvas.style.position="absolute",this.canvas.style.left=s+"px",this.canvas.style.top=r+"px",this.brush.root.appendChild(this.canvas),this.ctx=this.canvas.getContext("bitmaprenderer"),this.styles.useWork&&OffscreenCanvas&&(this.worker=new Worker("./src/worker.js"),this.worker.postMessage({type:"init",w:e,h:t}),this.worker.onmessage=e=>{let t=e.data;this.ctx.transferFromImageBitmap(t)})}addElement(e){return e.bind(this),this.el.push(e),e}render(){this.el.forEach(e=>{e.isNew||e.render()}),this.collectChildsCanvas()}collectChildsCanvas(){this.styles.useWork&&OffscreenCanvas&&Worker?this.offscreenCollect():this.normalCollect()}normalCollect(){this.el.forEach(e=>{let t=e.canvas,s=e.props.x,r=e.props.y;this.ctx.drawImage(t,s,r)})}offscreenCollect(){this.worker.postMessage({type:"begin"}),this.el.forEach(e=>{let t=e.canvas,s=e.props.x,r=e.props.y;this.worker.postMessage({type:"commit",data:t.transferToImageBitmap(),x:s,y:r})}),this.worker.postMessage({type:"end"})}receiveUpdate(e){this.updateMap.add(e),this.handleUpdate()}handleUpdate(){this.updater&&window.cancelAnimationFrame(this.updater),this.updater=window.requestAnimationFrame(()=>{this.signRenderChain(),this.render(),this.defaultAfterRender()})}signRenderChain(){for(let e of this.updateMap.values()){let t=e.renderChain;for(let e of t)e.isNew=!1}}defaultAfterRender(){this.updateMap=new Set}}class i{constructor(e={}){const t=this;this.elMap={},this.isNew=!1,this.renderChain=[this],this.hasInit=!1,this.isAnsysingDependence=!1,this.dependence={},this.baseProps={w:10,h:10,x:0,y:0},this.defaultProps={},this.props=new Proxy(e,{get(e,s){let r;return e.hasOwnProperty(s)?r=e[s]:t.defaultProps.hasOwnProperty(s)?r=t.defaultProps[s]:t.baseProps.hasOwnProperty(s)&&(r=t.baseProps[s]),t.isAnsysingDependence&&(t.dependence[s]=r),r},set(e,s,r){return s in["x","y"]?r!==this.props[s]&&t.father.update():s in["w","h"]&&this.update(),e[s]=r,!0}});let[s,r]=[this.props.w,this.props.w];OffscreenCanvas?this.canvas=new OffscreenCanvas(s,r):(this.canvas=document.createElement("canvas"),this.canvas.width=s,this.canvas.height=r),this.ctx=this.canvas.getContext("2d"),this.el=new Proxy({},{get(e,s){let r=t.elMap[s];return r.bind(t),e=>{void 0===e&&(e={});let s=r.renderWithProps(e),i=r.props.x,n=r.props.y;t.ctx.drawImage(s,i,n)}}})}bindFromLayer(e){this.father=e,this.layer=e,this.renderChain=[this],this.defaultCreated(),this.created(),this.created=function(){}}bind(e){this.father=e,this.layer=e.layer,this.renderChain=e.renderChain.slice(),this.renderChain.push(this),this.defaultCreated(),this.created(),this.created=function(){}}isChildsOverdue(){for(let e in this.elMap){if(!this.elMap[e].isNew)return!0}return!1}isWorthToUpdate(e){if(!this.hasInit)return!0;for(let t in e)if(this.dependence.hasOwnProperty(t)){if(this.hasChangeProps(e[t],this.dependence[t]))return!0}return!1}hasChangeProps(e,t){const s=function(e,t){if(e===t)return!1;if("object"==typeof e&&"object"==typeof t){for(let r in e){if(!t.hasOwnProperty(r))return!0;if("object"==typeof e[r]){if(s(e[r],t[r]))return!0}else if(e[r]!==t[r])return!0}return!1}return!0};return s(e,t)}renderWithProps(e){return Object.assign(this.props,e),this.isChildsOverdue()||this.isWorthToUpdate(e)?this.render():this.canvas}setProps(e){Object.assign(this.props,e)}clear(){this.canvas.width=this.canvas.width}setState(e){this.state||(this.state={}),this.state=Object.assign(this.state,e),this.update()}update(){this.layer.receiveUpdate(this)}render(){return this.defaultBeforePaint(),this.beforePaint(),this.paint(),this.afterPaint(),this.defaultAfterPaint(),this.canvas}defaultCreated(){}defaultBeforePaint(){this.isAnsysingDependence=!0,this.dependence={}}defaultAfterPaint(){this.hasInit||(this.hasInit=!0,this.updated()),this.isAnsysingDependence=!1,this.isNew=!0}reqFrame(e){e(),this.father.update()}positionChanged(){this.father.update()}sizeChanged(){this.canvas.w=this.w,this.canvas.h=this.h,this.update()}get w(){return this.props.w}get h(){return this.props.h}get x(){return this.props.x}get y(){return this.props.y}get bg(){return this.props.backgroundColor}created(){}beforePaint(){}afterPaint(){}updated(){}}s.d(t,"Brush",(function(){return n})),s.d(t,"BrushElement",(function(){return i}));class n{constructor({w:e,h:t,root:s,state:r={}}){this.style={w:e,h:t},this.root=s,this.subscriberMap={},this.state=new Proxy(r,{get:(e,t)=>e[t],set(e,t,s){e[t]=s,this.dispatch(t,s)}}),this.eventBus={},this.root.style.width=e+"px",this.root.style.height=t+"px",this.layers=[]}createLayer({style:e,el:t}){const s=new r({style:e,el:t},this);return this.layers.push(s),s}dispatch(e,t){this.subscriberMap.hasOwnProperty(e)&&(Array.isArray(this.subscriberMap[e])||this.subscriberMap[e].forEach(s=>{s(e,t)}))}subscribe(e,t){this.subscriberMap.hasOwnProperty(e)&&(Array.isArray(this.subscriberMap[e])||(this.subscriberMap[e]=[])),this.subscriberMap[e].push(t)}emitEvent(){}listenEvent(){}render(){this.layers.forEach(e=>{e.render()})}}}])}));