!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var s=e();for(var r in s)("object"==typeof exports?exports:t)[r]=s[r]}}(window,(function(){return function(t){var e={};function s(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=t,s.c=e,s.d=function(t,e,r){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)s.d(r,i,function(e){return t[e]}.bind(null,i));return r},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);const r=!1;class i{constructor({style:t={},el:e=[]},s,r){this.style=t,this.brush=s,this.index=r,this.updateMap=new Set,this.createCanvas(),this.el=this.toArray(e),this.el.forEach(t=>{t.bindFromLayer(this)})}createCanvas(){let t,e,s,i;this.canvas=document.createElement("canvas"),t=this.style.hasOwnProperty("w")?this.style.w:this.brush.style.w,e=this.style.hasOwnProperty("h")?this.style.h:this.brush.style.h,s=this.style.hasOwnProperty("x")?this.style.x:0,i=this.style.hasOwnProperty("y")?this.style.y:0,this.canvas.width=t,this.canvas.height=e,this.canvas.style.position="absolute",this.canvas.style.left=s+"px",this.canvas.style.top=i+"px",this.style.backgroundColor&&(this.canvas.style.background=this.style.backgroundColor),this.brush.root.appendChild(this.canvas),this.ctx=this.canvas.getContext(r?"bitmaprenderer":"2d",{alpha:!0}),r&&OffscreenCanvas&&(this.worker=new Worker("./src/worker.js"),this.worker.postMessage({type:"init",w:t,h:e}),this.worker.onmessage=t=>{let e=t.data;this.ctx.transferFromImageBitmap(e)})}addElement(t){return t.bind(this),this.el.push(t),t}isCanvasHasAlpha(){if(!0===this.style.alpha)return!0;if(!1===this.style.alpha)return!1;let t=this.style.backgroundColor;return!!t&&!!(t.length>=13&&"rgba"===t.substr(0,4)&&t.substr("1"===t.substr(t.length-2,1)))}get layerVisibility(){return this.brush.checkLayerVisibility(this.index)}render(){return!!this.layerVisibility&&(this.clear(),this.el.forEach(t=>{t.isNew||t.render()}),this.collectChildsCanvas(),!0)}clear(){this.canvas.width=this.canvas.width}collectChildsCanvas(){r&&OffscreenCanvas&&Worker?this.offscreenCollect():this.normalCollect()}normalCollect(){this.el.forEach(t=>{let e=t.canvas,s=t.props.x,r=t.props.y;this.ctx.drawImage(e,s,r)})}offscreenCollect(){this.worker.postMessage({type:"begin"}),this.el.forEach(t=>{let e=t.canvas,s=t.props.x,r=t.props.y;this.worker.postMessage({type:"commit",data:e.transferToImageBitmap(),x:s,y:r})}),this.worker.postMessage({type:"end"})}receiveUpdate(t){this.layerVisibility&&(this.updateMap.add(t),this.handleUpdate())}handleUpdate(){this.updater&&window.cancelAnimationFrame(this.updater),this.updater=window.requestAnimationFrame(()=>{this.signRenderChain();this.render();this.defaultAfterRender()})}signRenderChain(){for(let t of this.updateMap.values()){let e=t.renderChain;for(let t of e)t.isNew=!1}}defaultAfterRender(){this.updateMap=new Set}toArray(t){return Array.isArray(t)?t:t instanceof Object&&(t.hasOwnProperty(0)||t.hasOwnProperty("0"))?Array.from(t):[t]}}class n{constructor(t,e){this.el=e,this.oct=t;const s=this;return new Proxy(t,{get(t,e){if(s[e])return s[e];{let s=t[e];return s instanceof Function?s.bind(t):s}},set:(t,e,r)=>(s[e]?s[e]=r:t[e]=r,!0)})}isPercent(t){return"string"==typeof t&&"%"===t.substr(t.length-1)}rounded(t){let e=.5+t|0;return e=~~(.5+t),e=.5+t<<0}transData(t,e,s,r){return this.isPercent(t)&&(t=this.rounded(this.el.x*parseFloat(t)/100)),this.isPercent(e)&&(e=this.rounded(this.el.y*parseFloat(e)/100)),this.isPercent(s)&&(s=this.rounded(this.el.w*parseFloat(s)/100)),this.isPercent(r)&&(r=this.rounded(this.el.h*parseFloat(r)/100)),[t,e,s,r]}rect(t,e,s,r){[t,e,s,r]=this.transData(t,e,s,r),this.oct.fillRect(t,e,s,r)}circle(){}}class a{constructor(t={}){const e=this;this.childElements=[],this.elMap={},this.isNew=!1,this.renderChain=[this],this.hasInit=!1,this.isAnsysingDependence=!1,this.dependence={},this.stateDependence={},this.baseProps={w:100,h:100,x:0,y:0},this.defaultProps={},this.props=new Proxy(t,{get(t,s){let r;return t.hasOwnProperty(s)?r=t[s]:e.defaultProps.hasOwnProperty(s)?r=e.defaultProps[s]:e.baseProps.hasOwnProperty(s)&&(r=e.baseProps[s]),e.isAnsysingDependence&&(e.dependence[s]=r),r},set(t,s,r){return s in["x","y"]?r!==this.props[s]&&e.positionChanged():s in["w","h"]&&e.sizeChanged(),t[s]=r,!0}});const s={};this.el=new Proxy({},{get(t,r){if(!s.hasOwnProperty(r)){let t=e.elMap[r];t.bindFromElement(e);let i=s=>{void 0===s&&(s={});let r=t.renderWithProps(s),i=t.props.x,n=t.props.y;return e.ctx.drawImage(r,i,n),t};s[r]=i}return s[r]}}),this.data=new Proxy({},{get(t,s){if(e.state.hasOwnProperty(s)){let t=e.state[s];return e.isAnsysingDependence&&(e.stateDependence[s]=t),t}if(e.props.hasOwnProperty(s))return e.props[s]},set(t,s,r){e.ansysStateChange(s,r),e.state[s]=r}})}initOffscreenCanvas(){let[t,e]=[this.props.w,this.props.w];OffscreenCanvas?this.canvas=new OffscreenCanvas(t,e):(this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e),this.originContext=this.canvas.getContext("2d"),this.initContext()}initContext(){let t=this.canvas.getContext("2d");this.ctx=new n(t,this)}bindFromLayer(t){this.father=t,this.layer=t,this.renderChain=[this],this.defaultCreated(),this.created(),this.created=function(){}}bindFromElement(t){this.father=t,this.layer=t.layer,this.renderChain=t.renderChain.slice(),this.renderChain.push(this),this.defaultCreated(),this.created(),this.created=function(){}}toArray(t){return Array.isArray(t)?t:t instanceof Object&&(t.hasOwnProperty(0)||t.hasOwnProperty("0"))?Array.from(t):[t]}addChild(t){let e=this.toArray(t);this.childElements=e.map(t=>e=>{t.bindFromElement(this),void 0===e&&(e={});let s=t.renderWithProps(e),r=t.props.x,i=t.props.y;return that.ctx.drawImage(s,r,i),t})}isChildsOverdue(){for(let t in this.elMap){if(!this.elMap[t].isNew)return!0}return!1}isWorthToUpdate(t){if(!this.hasInit)return!0;for(let e in t)if(this.dependence.hasOwnProperty(e)){if(this.hasChangeProps(t[e],this.dependence[e]))return!0}return!1}hasChangeProps(t,e){const s=function(t,e){if(t===e)return!1;if("object"==typeof t&&"object"==typeof e){for(let r in t){if(!e.hasOwnProperty(r))return!0;if("object"==typeof t[r]){if(s(t[r],e[r]))return!0}else if(t[r]!==e[r])return!0}return!1}return!0};return s(t,e)}renderWithProps(t){return Object.assign(this.props,t),this.isChildsOverdue()||this.isWorthToUpdate(t)?this.render():this.canvas}setProps(t){Object.assign(this.props,t)}clear(){this.canvas.width=this.canvas.width}ansysStateChange(t,e){}setState(t){this.state||(this.state={}),this.state=Object.assign(this.state,t),this.update()}update(){this.layer.receiveUpdate(this)}render(){return this.defaultBeforePaint(),this.beforePaint(),this.paint(),this.afterPaint(),this.defaultAfterPaint(),this.canvas}defaultCreated(){this.initOffscreenCanvas()}defaultBeforePaint(){this.isAnsysingDependence=!0,this.dependence={},this.stateDependence={}}defaultAfterPaint(){this.hasInit||(this.hasInit=!0,this.updated()),this.isAnsysingDependence=!1,this.isNew=!0}reqFrame(t){t(),this.father.update()}positionChanged(){this.father.update()}sizeChanged(){this.canvas.w=this.w,this.canvas.h=this.h,this.update()}get w(){return this.props.w}get h(){return this.props.h}get x(){return this.props.x}get y(){return this.props.y}get bg(){return this.props.backgroundColor}created(){}beforePaint(){}afterPaint(){}updated(){}}s.d(e,"Brush",(function(){return h})),s.d(e,"BrushElement",(function(){return a}));class h{constructor({w:t,h:e,root:s,state:r={}}){this.style={w:t,h:e},this.root=s,this.subscriberMap={},this.state=new Proxy(r,{get:(t,e)=>t[e],set(t,e,s){t[e]=s,this.dispatch(e,s)}}),this.eventBus={},this.root.style.width=t+"px",this.root.style.height=e+"px",this.layers=[]}createLayer({style:t,el:e}){const s=new i({style:t,el:e},this,this.layers.length);return this.layers.push(s),s}checkLayerVisibility(t){for(let e=this.layers.length-1;e>=0;e--){if(e<=t)return!0;if(!this.layers[e].isCanvasHasAlpha())return!1}return!0}dispatch(t,e){this.subscriberMap.hasOwnProperty(t)&&(Array.isArray(this.subscriberMap[t])||this.subscriberMap[t].forEach(s=>{s(t,e)}))}subscribe(t,e){this.subscriberMap.hasOwnProperty(t)&&(Array.isArray(this.subscriberMap[t])||(this.subscriberMap[t]=[])),this.subscriberMap[t].push(e)}emitEvent(){}listenEvent(){}render(){this.layers.forEach(t=>{t.render()})}}}])}));