!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var s=e();for(var r in s)("object"==typeof exports?exports:t)[r]=s[r]}}(window,(function(){return function(t){var e={};function s(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=t,s.c=e,s.d=function(t,e,r){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)s.d(r,i,function(e){return t[e]}.bind(null,i));return r},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=2)}([function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return CanvasContext}));class CanvasContext{constructor(t,e){this.el=e,this.oct=t;const s=this;return new Proxy(t,{get(t,e){if(s[e])return s[e];{let s=t[e];return s instanceof Function?s.bind(t):s}},set:(t,e,r)=>(s[e]?s[e]=r:t[e]=r,!0)})}isPercent(t){return"string"==typeof t&&"%"===t.substr(t.length-1)}rounded(t){let e=.5+t|0;return e=~~(.5+t),e=.5+t<<0}transPercent(num,rate){if("string"==typeof num){let percentRate="*"+rate,vwRate="*"+this.el.layer.style.w/100,vhRate="*"+this.el.layer.style.h/100;return num=num.replace("%",percentRate),num=num.replace("vw",vwRate),num=num.replace("vh",vhRate),eval(num)}return num}transReferW(t){let e=this.el.w/100;return this.transPercent(t,e)}transReferH(t){let e=this.el.h/100;return this.transPercent(t,e)}transData(t,e,s,r){return[this.transReferW(t),this.transReferH(e),this.transReferW(s),this.transReferH(r)]}rect({x:t,y:e,w:s,h:r,border:i,color:n="black",backgroundColor:a}){[t,e,s,r]=this.transData(t,e,s,r),this.oct.save(),this.oct.rect(t,e,s,r),i?(i=this.transReferW(i),this.oct.strokeStyle=n,this.oct.lineWidth=i):this.oct.strokeStyle=a,a&&(this.oct.fillStyle=a),this.oct.stroke(),this.oct.fill(),this.oct.restore()}poly(t,e,s,r="black"){this.oct.strokeStyle=r,this.oct.lineWidth=s,this.oct.beginPath();let i=t[0],n=e[0];this.oct.moveTo(i,n);for(let s=1;s<t.length;s++)if(s<e.length){let r=t[s],i=e[s];this.oct.lineTo(r,i),this.oct.moveTo(r,i)}this.oct.lineTo(i,n),this.oct.moveTo(i,n),this.oct.closePath(),this.oct.stroke()}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return BrushProxy}));class BrushProxy{constructor(t){this.target=t,this.father=t.father,this.transX=0,this.transY=0,this.originX=0,this.originY=0}addChild(t){return this.target.addChild(t),this}isPercent(t){return"string"==typeof t&&"%"===t.substr(t.length-1)}rounded(t){let e=.5+t|0;return e=~~(.5+t),e=.5+t<<0}transPercent(num,rate){if("string"==typeof num){let percentRate="*"+rate,vwRate="*"+this.target.layer.style.w/100,vhRate="*"+this.target.layer.style.h/100;return num=num.replace("%",percentRate),num=num.replace("vw",vwRate),num=num.replace("vh",vhRate),eval(num)}return num}transReferW(t){let e=this.target.w/100;return this.transPercent(t,e)}transReferH(t){let e=this.target.h/100;return this.transPercent(t,e)}transData(t,e,s,r){return[this.transReferW(t),this.transReferH(e),this.transReferW(s),this.transReferH(r)]}paint(t){return void 0===t&&(t={}),this.target.isInFatherCanvas&&this.target.renderWithProps(t),this.father.ctx.save(),this.father.ctx.translate(this.target.x,this.target.y),this}rotate(t,e=0,s=0){return e=this.transReferW(e),s=this.transReferH(s),t=Math.PI*(t%360)/180,this.translate(e,s),this.originX=-e,this.originY=-s,this.father.ctx.rotate(t),this}translateX(t){return t=this.transReferW(t),this.transX=t,this}translateY(t){return t=this.transReferH(t),this.transY=t,this}translate(t,e){return this.translateX(t),this.translateY(e),this.father.ctx.translate(this.transX,this.transY),this}scale(t,e){return this.father.ctx.scale(t,e),this}transform(t,e,s,r,i,n){return this.father.ctx.transform(t,e,s,r,i,n),this}done(){this.father.ctx.drawImage(this.target.canvas,this.originX,this.originY),this.father.ctx.restore()}}},function(t,e,s){"use strict";s.r(e);const r=!1;class i{constructor({style:t={},el:e=[]},s,r){this.style=t,this.brush=s,this.index=r,this.eventSet=new Set,this.mouseInSet=new Set,this.mouseOutSet=new Set,this.updateSet=new Set,this.beforeUpdateCallbackSet=new Set,this.afterUpdateCallbackSet=new Set,this.createCanvas(),this.el=this.toArray(e),this.el.forEach(t=>{t.bindFromLayer(this)})}createCanvas(){let t,e,s,i;this.canvas=document.createElement("canvas"),t=this.style.hasOwnProperty("w")?this.style.w:this.brush.style.w,e=this.style.hasOwnProperty("h")?this.style.h:this.brush.style.h,s=this.style.hasOwnProperty("x")?this.style.x:0,i=this.style.hasOwnProperty("y")?this.style.y:0,this.canvas.width=t,this.canvas.height=e,this.canvas.style.position="absolute",this.canvas.style.left=s+"px",this.canvas.style.top=i+"px",this.style.backgroundColor&&(this.canvas.style.background=this.style.backgroundColor),this.registEvent(),this.brush.root.appendChild(this.canvas),this.ctx=this.canvas.getContext(r?"bitmaprenderer":"2d",{alpha:!0}),r&&OffscreenCanvas&&(this.worker=new Worker("./src/worker.js"),this.worker.postMessage({type:"init",w:t,h:e}),this.worker.onmessage=t=>{let e=t.data;this.ctx.transferFromImageBitmap(e)})}addElement(t){return t.bind(this),this.el.push(t),t}isCanvasHasAlpha(){if(!0===this.style.alpha)return!0;if(!1===this.style.alpha)return!1;let t=this.style.backgroundColor;return!!t&&!!(t.length>=13&&"rgba"===t.substr(0,4)&&t.substr("1"===t.substr(t.length-2,1)))}get layerVisibility(){return this.brush.checkLayerVisibility(this.index)}render(){return!!this.layerVisibility&&(this.clear(),this.el.forEach(t=>{t.isNew||t.render()}),this.collectChildsCanvas(),!0)}clear(){this.canvas.width=this.canvas.width}collectChildsCanvas(){r&&OffscreenCanvas&&Worker?this.offscreenCollect():this.normalCollect()}normalCollect(){this.el.forEach(t=>{let e=t.canvas,s=t.props.x,r=t.props.y;this.ctx.drawImage(e,s,r)})}offscreenCollect(){this.worker.postMessage({type:"begin"}),this.el.forEach(t=>{let e=t.canvas,s=t.props.x,r=t.props.y;this.worker.postMessage({type:"commit",data:e.transferToImageBitmap(),x:s,y:r})}),this.worker.postMessage({type:"end"})}receiveUpdate(t){this.layerVisibility&&t.isInFatherCanvas&&(this.updateSet.add(t),this.handleUpdate())}receiveBeforeUpdateCallback(t){t instanceof Function&&this.beforeUpdateCallbackSet.add(t)}receiveAfterUpdateCallback(t){t instanceof Function&&this.afterUpdateCallbackSet.add(t)}receiveNextFrameCallback(t){t instanceof Function&&this.nextFrameCallbackSet.add(t)}handleUpdate(){this.updater&&window.cancelAnimationFrame(this.updater),this.updater=window.requestAnimationFrame(()=>{this.signRenderChain(),this.defaultBeforeRender(),this.render(),this.defaultAfterRender()})}quickUpdate(){this.signRenderChain(),this.defaultBeforeRender(),this.render(),this.defaultAfterRender()}signRenderChain(){for(let t of this.updateSet.values()){let e=t.renderChain;for(let t of e)t.isNew=!1}}defaultBeforeRender(){let t=Array.from(this.beforeUpdateCallbackSet.values());for(let e of t)e instanceof Function&&e()}defaultAfterRender(){this.updateSet.clear();let t=Array.from(this.afterUpdateCallbackSet.values());this.beforeUpdateCallbackSet.clear(),this.afterUpdateCallbackSet.clear();for(let e of t)e instanceof Function&&e()}toArray(t){return Array.isArray(t)?t:t instanceof Object&&(t.hasOwnProperty(0)||t.hasOwnProperty("0"))?Array.from(t):[t]}eventDispatch(t,e,s){let r=this.toArray(this.el);for(let i=r.length-1;i>=0;i--){if(r[i].eventDispatch(t,e,s))return}}getMousePosition(t){let e,s;return t.pageX||t.pageY?(e=t.pageX,s=t.pageY):(e=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),e-=this.canvas.offsetLeft,s-=this.canvas.offsetTop,[e|=0,s|=0]}reportInEvent(t){this.mouseInSet.add(t)}reportOutEvent(t){this.mouseOutSet.add(t)}ansysMouseoverEventSet(){for(let t of this.mouseInSet.values())this.mouseInSetOld.has(t)||t.trigerEventFromSelf("in");for(let t of this.mouseOutSetOld.values())this.mouseOutSet.has(t)||t.trigerEventFromSelf("out")}registEvent(){this.eventSet.has("click")&&this.registClickEvent(),this.eventSet.has("over")&&this.registOverEvent()}registClickEvent(){this.canvas.addEventListener("click",t=>{let[e,s]=this.getMousePosition(t);this.eventDispatch("click",e,s)},!1)}registOverEvent(){this.canvas.addEventListener("mousemove",t=>{this.mouseInSetOld=this.mouseInSet,this.mouseOutSetOld=this.mouseOutSet,this.mouseInSet=new Set,this.mouseOutSet=new Set;let[e,s]=this.getMousePosition(t);this.eventDispatch("over",e,s),this.ansysMouseoverEventSet()},!1)}registEventFromElement(t){this.eventSet.has(t)||(this.eventSet.add(t),"click"===t?this.registClickEvent():"over"===t&&this.registOverEvent())}changeCursor(t){this.canvas.style.cursor=t}get x(){return this.style.x}get y(){return this.style.y}get w(){return this.style.w}get h(){return this.style.h}}var n=s(0),a=s(1);class h{constructor(t={}){const e=this;this.childElements=[],this.allChildElements=[],this.tempChildStack=[],this.tempChildSet=new Set,this.elMap={},this.isNew=!1,this.renderChain=[this],this.hasInit=!1,this.isAnsysingDependence=!1,this.isCollectingChilds=!1,this.dependence={},this.stateDependence={},this.eventsMap={},this.baseProps={w:100,h:100,x:0,y:0},this.defaultProps={},this.props=new Proxy(t,{get(t,s){let r;return t.hasOwnProperty(s)?r=t[s]:e.defaultProps.hasOwnProperty(s)?r=e.defaultProps[s]:e.baseProps.hasOwnProperty(s)&&(r=e.baseProps[s]),e.isAnsysingDependence&&(e.dependence[s]=r),r},set(t,s,r){return s in["x","y"]?r!==this.props[s]&&e.positionChanged():s in["w","h"]&&e.sizeChanged(),t[s]=r,!0}});const s={};this.el=new Proxy({},{get(t,r){if(!s.hasOwnProperty(r)){let t=e.elMap[r];t.bindFromElement(e);let i=new a.a(t);s[r]=i.paint.bind(i)}if(e.isCollectingChilds){let t=e.elMap[r];e.tempChildStack.push(t)}return s[r]}}),this.data=new Proxy({},{get(t,s){if(e.state.hasOwnProperty(s)){let t=e.state[s];return e.isAnsysingDependence&&(e.stateDependence[s]=t),t}if(e.props.hasOwnProperty(s))return e.props[s]},set(t,s,r){e.ansysStateChange(s,r),e.state[s]=r}})}initOffscreenCanvas(){let[t,e]=[this.props.w,this.props.w];OffscreenCanvas?this.canvas=new OffscreenCanvas(t,e):(this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e),this.originContext=this.canvas.getContext("2d"),this.initContext()}initContext(){let t=this.canvas.getContext("2d");this.ctx=new n.a(t,this)}bindFromLayer(t){this.father=t,this.layer=t,this.renderChain=[this],this.defaultCreated(),this.created(),this.created=function(){}}bindFromElement(t){this.father=t,this.layer=t.layer,this.renderChain=t.renderChain.slice(),this.renderChain.push(this),this.defaultCreated(),this.created(),this.created=function(){}}get isInFatherCanvas(){return this.x<this.father.w&&this.y<this.father.h}toArray(t){return Array.isArray(t)?t:t instanceof Object&&(t.hasOwnProperty(0)||t.hasOwnProperty("0"))?Array.from(t):[t]}addChild(t){let e=this.toArray(t);this.childElements=e.map(t=>e=>{t.bindFromElement(this),void 0===e&&(e={});let s=t.renderWithProps(e),r=t.props.x,i=t.props.y;return that.ctx.drawImage(s,r,i),t})}isChildsOverdue(){for(let t in this.elMap){if(!this.elMap[t].isNew)return!0}return!1}isWorthToUpdate(t){if(!this.hasInit)return!0;for(let e in t)if(this.dependence.hasOwnProperty(e)){if(this.hasChangeProps(t[e],this.dependence[e]))return!0}return!1}hasChangeProps(t,e){const s=function(t,e){if(t===e)return!1;if("object"==typeof t&&"object"==typeof e){for(let r in t){if(!e.hasOwnProperty(r))return!0;if("object"==typeof t[r]){if(s(t[r],e[r]))return!0}else if(t[r]!==e[r])return!0}return!1}return!0};return s(t,e)}renderWithProps(t){return Object.assign(this.props,t),!this.isNew||this.isChildsOverdue()||this.isWorthToUpdate(t)?this.render():this.canvas}setProps(t){Object.assign(this.props,t)}clear(){this.canvas.width=this.canvas.width,this.paintCanvasBackground()}ansysStateChange(t,e){}setState(t){this.state||(this.state={}),this.state=Object.assign(this.state,t),this.update()}__getStateChangeList(t){let e=[];const s=(t,r)=>{for(let i in t){let n=r.slice();n.push(i);let a=typeof t[i];if("object"===a)s(t[i],n);else if("number"===a){let s=t[i],r=this.findValueByKeys(n);s!=r&&e.push({target:s,origin:r,diff:s-r,keyList:n})}}};return s(t,[]),e}smoothState(t,e){this.state||(this.state={});let s=this.__getStateChangeList(t),r=(new Date).getTime();const i=()=>{let n=!1,a=(new Date).getTime(),h=Math.min(1,(a-r)/e);for(let e of s)if(e.target!==this.findValueByKeys(e.keyList)){let s=e.origin+e.diff*h;t=this.changeValueByKeys(t,e.keyList,s)}else n=!0;this.state||(this.state={}),this.state=Object.assign(this.state,t),n||this.afterUpdate(i.bind(this)),this.update()};s.length>0&&i()}infiniteState(t){let e,s=!0,r=this.__getStateChangeList(t),i=(new Date).getTime();const n=()=>{let e=(new Date).getTime()-i;for(let s of r){let r=s.target/1e3,i=s.origin+r*e;t=this.changeValueByKeys(t,s.keyList,i)}this.state||(this.state={}),this.state=Object.assign(this.state,t),s&&this.afterUpdate(n.bind(this)),this.update()};return r.length>0&&n(),{stop(){s=!1,e=(new Date).getTime()},start(){let t=(new Date).getTime();i+=t-e,s=!0,r.length>0&&n()},del(){s=null,r=null,i=null,e=null}}}findValueByKeys(t){let e=this.state;for(let s of t)e=e[s];return e}changeValueByKeys(t,e,s){let r=t;for(let t of e)"object"==typeof r[t]?r=r[t]:r[t]=s;return t}update(){this.isInFatherCanvas&&this.layer.receiveUpdate(this)}beforeUpdate(t){this.layer.receiveBeforeUpdateCallback(t)}afterUpdate(t){this.layer.receiveAfterUpdateCallback(t)}render(){return this.defaultBeforePaint(),this.beforePaint(),this.paintCanvasBackground(),this.paint(),this.afterPaint(),this.defaultAfterPaint(),this.canvas}paintCanvasBackground(){this.bg&&(this.ctx.save(),this.ctx.fillStyle=this.bg,this.ctx.fillRect(0,0,this.w,this.h),this.ctx.restore())}defaultCreated(){this.initOffscreenCanvas()}defaultBeforePaint(){this.isAnsysingDependence=!0,this.isCollectingChilds=!0,this.allChildElements=this.toArray(this.childElements).slice(),this.tempChildStack=[],this.tempChildSet.clear(),this.dependence={},this.stateDependence={}}defaultAfterPaint(){this.hasInit||(this.hasInit=!0,this.updated()),this.processChildsElement(),this.isAnsysingDependence=!1,this.isNew=!0}processChildsElement(){if(this.isCollectingChilds){for(;this.tempChildStack.length>0;){let t=this.tempChildStack.pop();if(!t.isInFatherCanvas)return;this.tempChildSet.has(t)||(this.tempChildSet.add(t),this.allChildElements.unshift(t))}this.tempChildStack=[],this.tempChildSet.clear(),this.isCollectingChilds=!1}}reqFrame(t){t(),this.father.update()}positionChanged(){this.father.update()}sizeChanged(){this.canvas.w=this.w,this.canvas.h=this.h,this.update()}eventDispatchControl(t,e,s,r){let i=r.x<=e&&e<=r.x+r.w,n=r.y<=s&&s<=r.y+r.h;i&&n&&r.eventDispatch(t,e-r.x,s-r.y)}eventDispatch(t,e,s){for(let r=this.allChildElements.length-1;r>=0;r--){let i=this.allChildElements[r];if(this.eventDispatchControl(t,e,s,i))return}return!!this.ctx.isPointInPath(e,s)&&(this.trigerEventFromSelf(t),!0)}trigerEvent(t){if(this.eventsMap.hasOwnProperty(t)){this.eventsMap[t].forEach(t=>{t()})}}trigerEventFromSelf(t){this.trigerEvent(t),this.eventBubbling(t)}trigerEventFromBubbling(t,e){this.trigerEvent(t),this.eventBubbling(t)}eventBubbling(t){this.father instanceof h&&this.father.trigerEventFromBubbling(t,this)}addEvent(t,e){this.eventsMap.hasOwnProperty(t)||(this.eventsMap[t]=[]),this.eventsMap[t].push(e),"in"===t?this.addEvent("over",()=>{this.layer.reportInEvent(this)}):"out"===t&&this.addEvent("over",()=>{this.layer.reportOutEvent(this)}),this.layer.registEventFromElement(t)}changeCursor(t){this.layer.changeCursor(t)}get w(){return this.props.w}get h(){return this.props.h}get x(){return this.props.x}get y(){return this.props.y}get bg(){return this.props.backgroundColor}created(){}beforePaint(){}afterPaint(){}updated(){}}s.d(e,"Brush",(function(){return o})),s.d(e,"BrushElement",(function(){return h}));class o{constructor({w:t,h:e,root:s,state:r={}}){this.style={w:t,h:e},this.root=s,this.subscriberMap={},this.state=new Proxy(r,{get:(t,e)=>t[e],set(t,e,s){t[e]=s,this.dispatch(e,s)}}),this.eventBus={},this.root.style.width=t+"px",this.root.style.height=e+"px",this.layers=[]}createLayer({style:t,el:e}){const s=new i({style:t,el:e},this,this.layers.length);return this.layers.push(s),s}checkLayerVisibility(t){for(let e=this.layers.length-1;e>=0;e--){if(e<=t)return!0;if(!this.layers[e].isCanvasHasAlpha())return!1}return!0}dispatch(t,e){this.subscriberMap.hasOwnProperty(t)&&(Array.isArray(this.subscriberMap[t])||this.subscriberMap[t].forEach(s=>{s(t,e)}))}subscribe(t,e){this.subscriberMap.hasOwnProperty(t)&&(Array.isArray(this.subscriberMap[t])||(this.subscriberMap[t]=[])),this.subscriberMap[t].push(e)}emitEvent(){}listenEvent(){}render(){this.layers.forEach(t=>{t.render()})}}}])}));